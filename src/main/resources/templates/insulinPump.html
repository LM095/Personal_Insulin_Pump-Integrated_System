<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Insulin pump device</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
    <script>
        class Measurement
        {
            constructor(r0, r1, r2, compDose)
            {
                this.r0 = r0;
                this.r1 = r1;
                this.r2 = r2;
                this.compDose = compDose;
            }
        }

        function connect()
        {
            let socket = new SockJS('/gs-guide-websocket');
            let stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame)
            {
                console.log('Connected: ' + frame);

                stompClient.subscribe('/topic/measurements', function (message)
                {
                    let parsedMeasurement = JSON.parse(message.body);
                    //optional, it wants a Measurement type
                    let measurement = Object.assign(new Measurement, parsedMeasurement);

                    document.getElementById("r2").innerText = measurement.r2.toFixed(2) + " Î¼g/ml";
                    document.getElementById("compDose").innerText = measurement.compDose + " unit(s)";

                    if(document.getElementById("state").innerText.includes("Booting"))
                    {
                        document.getElementById("state").innerText = "RUNNING";
                    }

                    console.log(measurement);
                });

                stompClient.subscribe('/topic/state', function (message)
                {
                    let stateElement = document.getElementById("state");

                    if(stateElement.innerText.includes("RUNNING") || stateElement.innerText.includes("Booting"))
                        stateElement.innerText = "";

                    stateElement.innerText = message.body + "\n" + stateElement.innerText;

                    stateElement.parentElement.style.borderColor = "darkred";
                    stateElement.parentElement.style.backgroundColor = "darkred";
                    stateElement.parentElement.style.color = "white";

                    document.getElementById("rebootForm").style.display = "block";
                });
            });
        }

        connect();
    </script>

    <style>
        body
        {
            background-image: url('/images/blue pattern.jpg');
        }

        .displayStyle
        {
            display: flex;
            justify-content: center;
            align-items: center;

            font-size: 48px;
            background-color: white;
            background-image: url('/images/display.png');
            background-size: 100%;
            width: 388px;
            height: 82px;
            background-repeat: no-repeat;
            border-style: solid;
            border-width: thin;
            border-color: grey;
            padding: 5px;
        }

        .displayStateStyle
        {
            display: flex;
            justify-content: center;
            align-items: center;

            background-color: #ccffb5;
            background-image: url("/images/display.png");
            background-size: 100%;
            width: 388px;
            height: 82px;
            background-repeat: no-repeat;
            border-style: solid;
            border-width: 2px;
            border-color: darkgreen;
            padding: 5px;
        }

        .column {
            float: left;
            width: 50%;
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        .button {
            background-color: white;
            border: none;
            color: black;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            transition-duration: 0.4s;
            border: 2px solid dodgerblue;
            margin: 50px;
        }

        .button:hover {
            background-color: dodgerblue;
            color: white;
        }
    </style>
</head>

<body>

<center>
    <div>
        <h1 style="background-color: rgba(255, 255, 255, 0.4); padding: 5px; width: 50%">
            Personal insulin pump device
        </h1>

        <div class="column">
            <h3>Last blood sugar level measurement:</h3>
            <div class="displayStyle">
                <p id="r2">Booting device...</p> &nbsp;
            </div>

            <h3>Last insulin dose injected:</h3>
            <div class="displayStyle">
                <p id="compDose">Booting device...</p>
            </div>
        </div>

        <div class="column">
            <h3>Current device state:</h3>
            <div class="displayStateStyle">
                <p id="state">Booting device...</p>
            </div>

            <h3>Clock:</h3>
            <div class="displayStyle">
                <iframe src="http://free.timeanddate.com/clock/i7m2s6i5/n254/tlit6/fn12/fs48/tct/pct" frameborder="0" width="234" height="50" allowTransparency="true"></iframe>
            </div>

        </div>

        <form action="rebootDevice" id="rebootForm" style="display: none;">
            <button type="submit" class="button">Reboot device</button>
        </form>
    </div>
</center>


</body>
</html>